<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Govt Dashboard - CRM Analytics</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <i class="fa-solid fa-landmark"></i> Govt Admin
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="nav-item active" onclick="switchView('analytics', this)"><i class="fa-solid fa-chart-line"></i> Analytics</a>
                <a href="#" class="nav-item" onclick="switchView('all-chcs', this)"><i class="fa-solid fa-building"></i> All CHCs</a>
                <a href="#" class="nav-item" onclick="switchView('reports', this)"><i class="fa-solid fa-file-invoice"></i> Reports</a>
                <a href="#" class="nav-item" onclick="switchView('register-chc', this)"><i class="fa-solid fa-plus-circle"></i> Register CHC</a>
                <a href="#" class="nav-item" onclick="switchView('register-admin', this)"><i class="fa-solid fa-user-plus"></i> Register Admin</a>
                <a href="#" class="nav-item" onclick="switchView('assign-admin', this)"><i class="fa-solid fa-people-arrows"></i> Assign Admin</a>
                <a href="#" class="nav-item" onclick="switchView('profile', this)"><i class="fa-solid fa-id-badge"></i> Profile</a>
                <a href="#" class="nav-item" onclick="API.logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            </nav>
        </aside>

        <main class="main-content" id="view-analytics">
            <header class="flex justify-between items-center mb-8">
                <h2>National CRM Analytics</h2>
                <div class="flex items-center gap-4">
                    <button class="btn btn-primary" onclick="UI.showToast('Export feature coming soon', 'info')"><i class="fa-solid fa-download"></i> Export Report</button>
                </div>
            </header>

            <!-- State-Level Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stat-card bg-gradient-to-r from-blue-50 to-white shadow-sm border border-blue-100 p-5 rounded-xl">
                   <div class="stat-label text-blue-600 font-semibold mb-1 uppercase tracking-wider text-xs"><i class="fa-solid fa-building mr-2"></i>Active CHCs</div>
                   <div class="stat-value text-3xl font-bold text-gray-800" id="stat-chcs">0</div>
                </div>
                <div class="stat-card bg-gradient-to-r from-emerald-50 to-white shadow-sm border border-emerald-100 p-5 rounded-xl">
                   <div class="stat-label text-emerald-600 font-semibold mb-1 uppercase tracking-wider text-xs"><i class="fa-solid fa-leaf mr-2"></i>Residue Managed</div>
                   <div class="stat-value text-3xl font-bold text-gray-800" id="stat-residue">0 Tons</div>
                </div>
                <div class="stat-card bg-gradient-to-r from-indigo-50 to-white shadow-sm border border-indigo-100 p-5 rounded-xl">
                   <div class="stat-label text-indigo-600 font-semibold mb-1 uppercase tracking-wider text-xs"><i class="fa-solid fa-map mr-2"></i>Area Covered</div>
                   <div class="stat-value text-3xl font-bold text-gray-800" id="stat-area">0 Acres</div>
                </div>
                <div class="stat-card bg-gradient-to-r from-purple-50 to-white shadow-sm border border-purple-100 p-5 rounded-xl">
                   <div class="stat-label text-purple-600 font-semibold mb-1 uppercase tracking-wider text-xs"><i class="fa-solid fa-clock mr-2"></i>Total Usage</div>
                   <div class="stat-value text-3xl font-bold text-gray-800" id="stat-hours">0 Hrs</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="glass-panel p-5 rounded-xl shadow-sm border border-gray-100 col-span-1">
                    <h3 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-3 mb-4"><i class="fa-solid fa-power-off text-blue-500 mr-2"></i>Machine Status</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="glass-panel p-5 rounded-xl shadow-sm border border-gray-100 col-span-2">
                    <h3 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-3 mb-4"><i class="fa-solid fa-tractor text-green-600 mr-2"></i>Inventory Distribution</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- CHC Leaderboard Matrix -->
            <div class="glass-panel rounded-xl shadow-sm border border-gray-100 bg-white mb-8 overflow-hidden">
                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-ranking-star text-yellow-500 mr-2"></i>Top 5 Performing CHCs</h3>
                    <div class="w-64">
                         <input type="text" id="chc-search" placeholder="Search Top CHCs..." class="w-full text-sm py-1.5 focus:ring-blue-500" onkeyup="filterLeaderboard()">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" id="chc-table">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                                <th class="p-4 border-b font-semibold">CHC Name & District</th>
                                <th class="p-4 border-b font-semibold text-center">Machines (Active/Total)</th>
                                <th class="p-4 border-b font-semibold text-center">Bookings (Active/Total)</th>
                                <th class="p-4 border-b font-semibold text-right">Usage (Hrs)</th>
                                <th class="p-4 border-b font-semibold text-right">Area (Acres)</th>
                                <th class="p-4 border-b font-semibold text-right">Residue (Tons)</th>
                            </tr>
                        </thead>
                        <tbody id="chc-table-body" class="text-sm divide-y divide-gray-100">
                            <!-- Populated by JS -->
                            <tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading analytics...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="chc-table-pagination" class="flex justify-center gap-2 mt-4 pb-4"></div>
            </div>
        </main>

        <!-- All CHCs View -->
        <main class="main-content hidden" id="view-all-chcs">
            <header class="flex justify-between items-center mb-8">
                <h2>All Common Hiring Centers</h2>
                <div class="flex items-center gap-4 border bg-white rounded-lg px-3 py-1 shadow-sm">
                    <i class="fa-solid fa-search text-gray-400"></i>
                    <input type="text" id="global-chc-search" placeholder="Search centers..." class="border-none focus:ring-0 text-sm" onkeyup="filterAllCHCs()">
                </div>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="all-chcs-grid">
                <!-- Populated by JS -->
            </div>
            
            <div class="mt-6 flex justify-center gap-2 pb-8" id="all-chcs-pagination">
                <!-- Pagination -->
            </div>
        </main>

        <!-- Reports View -->
        <main class="main-content hidden" id="view-reports">
            <header class="flex justify-between items-center mb-8">
                <h2>Analytics & Insights Reports</h2>
                <div class="flex items-center gap-4">
                    <button class="btn btn-primary" onclick="UI.showToast('Generating PDF...', 'success')"><i class="fa-solid fa-print"></i> Generate PDF</button>
                </div>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" id="reports-charts-container">
                <!-- District Performance Chart -->
                <div class="glass-panel p-5 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-3 mb-4"><i class="fa-solid fa-map-location-dot text-indigo-500 mr-2"></i>District Utilization</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="districtChart"></canvas>
                    </div>
                </div>
                <!-- Idle Ratio Chart -->
                <div class="glass-panel p-5 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-3 mb-4"><i class="fa-solid fa-triangle-exclamation text-amber-500 mr-2"></i>Resource Inefficiency</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="idleChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-xl shadow-sm border border-gray-100 mb-8">
                <h3 class="text-lg font-bold text-gray-800 border-b border-gray-100 pb-3 mb-4"><i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>AI Driven Recommendations</h3>
                <div id="recommendations-container" class="space-y-3">
                   <!-- Populated by JS -->
                   <div class="p-4 rounded-lg bg-gray-50 border border-gray-100 text-gray-500 text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Analyzing data...</div>
                </div>
                <div id="recommendations-pagination" class="flex justify-center gap-2 mt-4 pb-2"></div>
            </div>
        </main>

        <!-- Register CHC View -->
        <main class="main-content hidden" id="view-register-chc">
            <header class="mb-8">
                <h2>Register New CHC</h2>
            </header>
            <div class="glass-panel p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                <form id="form-register-chc" onsubmit="handleRegisterCHC(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">CHC Name</label>
                        <input type="text" id="chc-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">State</label>
                            <input type="text" id="chc-state" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">District</label>
                            <input type="text" id="chc-district" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Complete Address</label>
                        <textarea id="chc-location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pincode</label>
                            <input type="text" id="chc-pincode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contact Number</label>
                            <input type="text" id="chc-contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="chc-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create CHC
                    </button>
                </form>
            </div>
        </main>

        <!-- Register Admin View -->
        <main class="main-content hidden" id="view-register-admin">
            <header class="mb-8">
                <h2>Register CHC Administrator</h2>
            </header>
            <div class="glass-panel p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                <form id="form-register-admin" onsubmit="handleRegisterAdmin(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="adm-first-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="adm-last-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username (Required)</label>
                        <input type="text" id="adm-username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="adm-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="adm-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="adm-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Administrator Account
                    </button>
                </form>
            </div>
        </main>

        <!-- Assign Admin View -->
        <main class="main-content hidden" id="view-assign-admin">
            <header class="mb-8">
                <h2>Assign Administrator to CHC</h2>
            </header>
            <div class="glass-panel p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
                <form id="form-assign-admin" onsubmit="handleAssignAdmin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Search & Select CHC</label>
                        <input list="chc-list" id="assign-chc-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Type to search CHCs..." required>
                        <datalist id="chc-list">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 text-muted mt-2 mb-1">Search & Select Administrator</label>
                        <input list="admin-list" id="assign-admin-input" placeholder="Type to search administrators..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                        <datalist id="admin-list">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Assign Administrator
                    </button>
                </form>
            </div>
        </main>

        <!-- Profile View -->
        <main class="main-content hidden" id="view-profile">
            <header class="mb-8">
                <h2>My Profile</h2>
            </header>
            <div class="glass-panel p-6 rounded-xl shadow-sm border border-gray-100 max-w-2xl mx-auto space-y-8">
                <form id="form-update-profile" onsubmit="handleUpdateProfile(event)" class="space-y-4">
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">Personal Details</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="prof-username" class="mt-1 block w-full rounded-md bg-gray-50 border-gray-300 shadow-sm sm:text-sm" disabled>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="prof-first-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="prof-last-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="prof-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mobile Number</label>
                            <input type="text" id="prof-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Update Details
                    </button>
                </form>

                <form id="form-change-pwd" onsubmit="handleChangePassword(event)" class="space-y-4 border-t pt-6">
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">Security</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">New Password</label>
                        <input type="password" id="prof-new-pwd" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required minlength="6">
                    </div>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                        Change Password
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- CHC Detailed Analytics Modal -->
    <div id="chc-detail-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl w-full p-0 overflow-hidden bg-gray-50 flex flex-col max-h-[85vh]">
            <!-- Header -->
            <div class="bg-white p-6 justify-between flex items-start border-b border-gray-200 shrink-0">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="modal-chc-name">Loading Details...</h2>
                    <div class="text-sm text-gray-500 mt-1 flex items-center gap-4">
                        <span id="modal-chc-district"><i class="fa-solid fa-location-dot text-gray-400 mr-1"></i> -</span>
                        <span id="modal-chc-admin"><i class="fa-solid fa-user text-gray-400 mr-1"></i> -</span>
                        <span id="modal-chc-contact"><i class="fa-solid fa-phone text-gray-400 mr-1"></i> -</span>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-red-500 shrink-0" onclick="closeCHCModal()"><i class="fa-solid fa-times fa-lg"></i></button>
            </div>
            
            <!-- Tabs -->
            <div class="bg-white border-b border-gray-200 px-6 shrink-0">
                <nav class="flex gap-6">
                    <button class="py-3 border-b-2 font-medium text-sm border-primary text-primary" id="tab-btn-machines" onclick="switchModalTab('machines')">Inventory Base</button>
                    <button class="py-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" id="tab-btn-usage" onclick="switchModalTab('usage')">Usage Logs</button>
                    <button class="py-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700" id="tab-btn-bookings" onclick="switchModalTab('bookings')">Recent Bookings</button>
                </nav>
            </div>

            <!-- Scrollable Content -->
            <div class="p-6 overflow-y-auto grow">
                <!-- Machines Tab -->
                <div id="tab-machines" class="space-y-4 tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="modal-machines-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Usage Tab -->
                <div id="tab-usage" class="hidden tab-content">
                    <div class="bg-white rounded border border-gray-200 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm table-fixed">
                            <thead>
                                <tr class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                                    <th class="p-3 w-1/4">Date</th>
                                    <th class="p-3 w-1/4">Farmer</th>
                                    <th class="p-3 w-1/4">Machine</th>
                                    <th class="p-3 w-1/8 text-right">Hrs</th>
                                    <th class="p-3 w-1/8 text-right">Acres</th>
                                </tr>
                            </thead>
                            <tbody id="modal-usage-list" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bookings Tab -->
                <div id="tab-bookings" class="hidden tab-content">
                    <div class="bg-white rounded border border-gray-200 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm table-fixed">
                            <thead>
                                <tr class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                                    <th class="p-3 w-1/4">Date Range</th>
                                    <th class="p-3 w-1/4">Farmer</th>
                                    <th class="p-3 w-1/4">Machine</th>
                                    <th class="p-3 w-1/4 text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody id="modal-bookings-list" class="divide-y divide-gray-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script>
        if (!localStorage.getItem('access_token')) {
            window.location.href = 'index.html';
        }

        let statusChart, typeChart, districtChart, idleChart;
        let globalChcData = [];
        let globalRecommendations = [];
        let reportsLoaded = false;

        const ITEMS_PER_PAGE = 10;
        let currentAllCHCsPage = 1;
        let currentRecommendationsPage = 1;

        // Render Pagination Controls Helper
        function renderPagination(totalItems, currentPage, containerId, pageChangeCallback) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.className = 'px-3 py-1 border border-gray-200 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 disabled:opacity-50';
            prevBtn.innerText = 'Prev';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => pageChangeCallback(currentPage - 1);
            container.appendChild(prevBtn);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const btn = document.createElement('button');
                    btn.className = `px-3 py-1 rounded text-sm font-medium ${i === currentPage ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100 text-gray-700'}`;
                    btn.innerText = i;
                    btn.onclick = () => pageChangeCallback(i);
                    container.appendChild(btn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const span = document.createElement('span');
                    span.className = 'px-2 py-1 text-gray-400';
                    span.innerText = '...';
                    container.appendChild(span);
                }
            }

            const nextBtn = document.createElement('button');
            nextBtn.className = 'px-3 py-1 border border-gray-200 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 disabled:opacity-50';
            nextBtn.innerText = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => pageChangeCallback(currentPage + 1);
            container.appendChild(nextBtn);
        }

        function closeCHCModal() {
            document.getElementById('chc-detail-modal').style.display = 'none';
        }
        
        // --- View Switching ---
        function switchView(viewId, element) {
            document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active'));
            if(element) element.classList.add('active');
            
            document.querySelectorAll('main.main-content').forEach(m => m.classList.add('hidden'));
            const showView = document.getElementById('view-' + viewId);
            if(showView) showView.classList.remove('hidden');
            
            if (viewId === 'all-chcs') {
               renderAllCHCsGrid(globalChcData);
            } else if (viewId === 'reports' && !reportsLoaded) {
               loadReportsData();
            } else if (viewId === 'profile') {
               loadProfileForView();
            } else if (viewId === 'assign-admin') {
               populateAssignDropdowns();
            }
        }

        async function loadGovtStats() {
            try {
                const data = await API.getGovtDashboard();
                
                // Populate Overview
                document.getElementById('stat-chcs').textContent = data.overview.total_chcs || 0;
                document.getElementById('stat-residue').textContent = `${data.overview.total_residue_managed || 0} Tons`;
                document.getElementById('stat-area').textContent = `${data.overview.total_area_covered || 0} Acres`;
                document.getElementById('stat-hours').textContent = `${data.overview.total_usage_hours || 0} Hrs`;

                renderCharts(data.charts);
                
                // Populate Table
                globalChcData = data.chc_analytics || [];
                renderCHCTable(globalChcData);
                
            } catch (err) {
                console.error(err);
                UI.showToast('Failed to load deep analytics', 'error');
                document.getElementById('chc-table-body').innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Failed to load data.</td></tr>`;
            }
        }

        function renderCharts(chartsData) {
            // Destroy previous charts
            if (statusChart) statusChart.destroy();
            if (typeChart) typeChart.destroy();

            // 1. Status Breakdown Doughnut
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            const statusLabels = Object.keys(chartsData.status_breakdown || {});
            const statusValues = Object.values(chartsData.status_breakdown || {});
            
            // Map colors safely
            const colorMap = {
                'In Use': '#10b981', // green
                'Idle': '#94a3b8',   // slate
                'Maintenance': '#f59e0b', // amber
                'Out of Service': '#ef4444' // red
            };
            const statusColors = statusLabels.map(label => colorMap[label] || '#cbd5e1');

            statusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: statusLabels.length ? statusLabels : ['No Data'],
                    datasets: [{
                        data: statusValues.length ? statusValues : [1],
                        backgroundColor: statusValues.length ? statusColors : ['#f1f5f9'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                    }
                }
            });

            // 2. Machine Types Bar Chart
            const ctxType = document.getElementById('typeChart').getContext('2d');
            const typeLabels = Object.keys(chartsData.machine_types || {});
            const typeValues = Object.values(chartsData.machine_types || {});

            typeChart = new Chart(ctxType, {
                type: 'bar',
                data: {
                    labels: typeLabels.length ? typeLabels : ['No Data'],
                    datasets: [{
                        label: 'Quantity',
                        data: typeValues.length ? typeValues : [0],
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(37, 99, 235)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderCHCTable(data) {
            const tbody = document.getElementById('chc-table-body');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">No CHC data available.</td></tr>';
                return;
            }

            // Sort by area covered descending by default
            const sortedData = [...data].sort((a, b) => b.area_covered - a.area_covered);
            
            // Only show Top 5
            const top5Data = sortedData.slice(0, 5);

            top5Data.forEach(chc => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/30 transition-colors group cursor-default';
                
                // Calculate utilization percentage for visual indicators
                const machineUtil = chc.total_machines > 0 ? (chc.active_machines / chc.total_machines) * 100 : 0;
                
                tr.innerHTML = `
                    <td class="p-4 border-b">
                        <div class="font-bold text-gray-800 text-base">${chc.chc_name}</div>
                        <div class="text-xs text-muted flex items-center gap-1 mt-1">
                            <i class="fa-solid fa-location-dot"></i> ${chc.district}
                        </div>
                    </td>
                    <td class="p-4 border-b text-center">
                        <div class="flex flex-col items-center">
                            <span class="font-semibold text-gray-800">${chc.active_machines} <span class="text-gray-400 font-normal">/ ${chc.total_machines}</span></span>
                            <div class="w-16 h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full" style="width: ${machineUtil}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 border-b text-center">
                        <span class="inline-flex items-center justify-center bg-green-50 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-100">
                             ${chc.active_bookings} Active
                        </span>
                        <div class="text-xs text-gray-400 mt-1">${chc.total_bookings} Total</div>
                    </td>
                    <td class="p-4 border-b text-right font-medium text-gray-700">
                        ${chc.total_hours} <span class="text-xs text-gray-400 font-normal">hrs</span>
                    </td>
                    <td class="p-4 border-b text-right font-bold text-blue-600">
                        ${chc.area_covered} <span class="text-xs text-blue-400 font-normal">ac</span>
                    </td>
                    <td class="p-4 border-b text-right font-bold text-emerald-600">
                        ${chc.residue_managed} <span class="text-xs text-emerald-400 font-normal">t</span>
                    </td>
                    <td class="p-4 border-b text-right">
                        <button class="btn btn-secondary text-xs px-2 py-1" onclick="openCHCDetails(${chc.chc_id})">Details <i class="fa-solid fa-arrow-right ml-1"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function filterLeaderboard() {
            const query = document.getElementById('chc-search').value.toLowerCase();
            if (!query) {
                renderCHCTable(globalChcData);
                return;
            }
            
            const filtered = globalChcData.filter(chc => 
                chc.chc_name.toLowerCase().includes(query) || 
                chc.district.toLowerCase().includes(query)
            );
            renderCHCTable(filtered);
        }

        // --- All CHCs Grid Logic ---
        function renderAllCHCsGrid(data) {
            const grid = document.getElementById('all-chcs-grid');
            grid.innerHTML = '';
            
            if (!data || data.length === 0) {
                grid.innerHTML = '<div class="col-span-full p-8 text-center text-gray-500">No centers found matching your search.</div>';
                const pagContainer = document.getElementById('all-chcs-pagination');
                if (pagContainer) pagContainer.innerHTML = '';
                return;
            }

            // Pagination Slicing
            const startIndex = (currentAllCHCsPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(chc => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:border-primary transition-colors flex flex-col justify-between';
                
                // Add mini visual utilization bar
                const machineUtil = chc.total_machines > 0 ? (chc.active_machines / chc.total_machines) * 100 : 0;
                
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${chc.chc_name}</h3>
                            <span class="bg-blue-50 text-blue-600 text-[10px] uppercase font-bold px-2 py-1 rounded border border-blue-100">${chc.district}</span>
                        </div>
                        
                        <div class="mt-4 space-y-3">
                            <div>
                                <div class="flex justify-between text-xs mb-1 font-semibold text-gray-600">
                                    <span>Equipment Usage</span>
                                    <span>${chc.active_machines}/${chc.total_machines}</span>
                                </div>
                                <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                     <div class="h-full bg-blue-500 rounded-full" style="width: ${machineUtil}%"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 text-sm pt-2 border-t border-gray-100">
                                <div>
                                    <div class="text-xs text-gray-400 font-medium">Usage Hours</div>
                                    <div class="font-bold text-gray-700">${chc.total_hours}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400 font-medium">Area Covered</div>
                                    <div class="font-bold text-gray-700">${chc.area_covered} ac</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5 pt-4 border-t border-gray-100 flex justify-end">
                        <button class="text-primary hover:text-blue-700 font-semibold text-sm flex items-center gap-1 group transition-colors" onclick="openCHCDetails(${chc.chc_id})">
                            Detailed Analytics <i class="fa-solid fa-arrow-right transform group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            renderPagination(data.length, currentAllCHCsPage, 'all-chcs-pagination', (newPage) => {
                currentAllCHCsPage = newPage;
                renderAllCHCsGrid(data);
            });
        }
        
        function filterAllCHCs() {
            currentAllCHCsPage = 1;
            const query = document.getElementById('global-chc-search').value.toLowerCase();
            if (!query) {
                renderAllCHCsGrid(globalChcData);
                return;
            }
            
            const filtered = globalChcData.filter(chc => 
                chc.chc_name.toLowerCase().includes(query) || 
                chc.district.toLowerCase().includes(query)
            );
            renderAllCHCsGrid(filtered);
        }

        // --- Detailed CHC Modal Logic ---
        function switchModalTab(tabName) {
            document.querySelectorAll('#chc-detail-modal .tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            
            document.querySelectorAll('#chc-detail-modal nav button').forEach(b => {
                b.classList.remove('border-primary', 'text-primary');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-primary', 'text-primary');
        }

        async function openCHCDetails(chcId) {
            // Setup loading state
            document.getElementById('modal-chc-name').textContent = "Loading Analytics...";
            document.getElementById('modal-chc-district').innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i>`;
            document.getElementById('modal-chc-admin').innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i>`;
            document.getElementById('modal-chc-contact').innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i>`;
            
            document.getElementById('modal-machines-list').innerHTML = '';
            document.getElementById('modal-usage-list').innerHTML = '';
            document.getElementById('modal-bookings-list').innerHTML = '';
            
            switchModalTab('machines');
            UI.showModal('chc-detail-modal');

            try {
                const data = await API.getGovtCHCDetailedAnalytics(chcId);
                
                // Header Info
                document.getElementById('modal-chc-name').textContent = data.chc_info.name;
                document.getElementById('modal-chc-district').innerHTML = `<i class="fa-solid fa-location-dot text-gray-400 mr-1"></i> ${data.chc_info.district}`;
                document.getElementById('modal-chc-admin').innerHTML = `<i class="fa-solid fa-user text-gray-400 mr-1"></i> ${data.chc_info.admin}`;
                document.getElementById('modal-chc-contact').innerHTML = `<i class="fa-solid fa-phone text-gray-400 mr-1"></i> ${data.chc_info.contact}`;

                // Machines Tab
                const mList = document.getElementById('modal-machines-list');
                if(data.machines && data.machines.length > 0) {
                    data.machines.forEach(m => {
                        let bClass = m.status === 'Available' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-yellow-50 text-yellow-600 border-yellow-200';
                        if (m.status === 'In Use') bClass = 'bg-blue-50 text-blue-600 border-blue-200';
                        if (m.status === 'Maintenance' || m.status === 'Out of Service') bClass = 'bg-red-50 text-red-600 border-red-200';
                        
                        mList.innerHTML += `
                            <div class="p-4 bg-white border border-gray-200 rounded shadow-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-gray-800">${m.name}</div>
                                    <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${bClass}">${m.status}</span>
                                </div>
                                <div class="text-xs text-gray-500 mb-3">${m.code} | ${m.type}</div>
                                <div class="grid grid-cols-2 gap-2 text-xs border-t border-gray-100 pt-2">
                                    <div><span class="text-gray-400 block">Total Hrs</span> <span class="font-semibold">${m.hours}</span></div>
                                    <div><span class="text-gray-400 block">Last Used</span> <span class="font-semibold">${m.last_used || 'Never'}</span></div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    mList.innerHTML = '<div class="col-span-full p-4 text-gray-500 italic">No machines registered.</div>';
                }

                // Usage Tab
                const uList = document.getElementById('modal-usage-list');
                if(data.recent_usage && data.recent_usage.length > 0) {
                     data.recent_usage.forEach(u => {
                         uList.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3 border-b text-gray-700">${u.date}</td>
                                <td class="p-3 border-b font-medium">${u.farmer}</td>
                                <td class="p-3 border-b text-gray-600">${u.machine}</td>
                                <td class="p-3 border-b text-right font-semibold text-blue-600">${u.hours}</td>
                                <td class="p-3 border-b text-right font-semibold text-emerald-600">${u.area}</td>
                            </tr>
                         `;
                     });
                } else {
                     uList.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">No recent usage.</td></tr>';
                }

                // Bookings Tab
                const bList = document.getElementById('modal-bookings-list');
                if(data.recent_bookings && data.recent_bookings.length > 0) {
                     data.recent_bookings.forEach(b => {
                         let statusBadge = `<span class="px-2 py-1 text-[10px] rounded uppercase font-bold border border-gray-200 text-gray-600">${b.status}</span>`;
                         if(b.status === 'Active') statusBadge = `<span class="px-2 py-1 text-[10px] rounded uppercase font-bold border border-green-200 bg-green-50 text-green-600">${b.status}</span>`;
                         if(b.status === 'Pending') statusBadge = `<span class="px-2 py-1 text-[10px] rounded uppercase font-bold border border-yellow-200 bg-yellow-50 text-yellow-600">${b.status}</span>`;

                         bList.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3 border-b text-xs text-gray-500">${b.start_date} <br>to ${b.end_date}</td>
                                <td class="p-3 border-b font-medium">${b.farmer}</td>
                                <td class="p-3 border-b text-gray-600">${b.machine}</td>
                                <td class="p-3 border-b text-right">${statusBadge}</td>
                            </tr>
                         `;
                     });
                } else {
                     bList.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500 italic">No recent bookings.</td></tr>';
                }
                
            } catch(e) {
                console.error(e);
                UI.hideModal('chc-detail-modal');
                UI.showToast('Failed to load CHC details', 'error');
            }
        }

        function renderRecommendations() {
            const recContainer = document.getElementById('recommendations-container');
            recContainer.innerHTML = '';
            
            if(!globalRecommendations || globalRecommendations.length === 0) {
                 recContainer.innerHTML = '<div class="p-4 rounded-lg bg-gray-50 border border-gray-100 text-gray-500 italic">No urgent insights generated at this time.</div>';
                 const pagContainer = document.getElementById('recommendations-pagination');
                 if (pagContainer) pagContainer.innerHTML = '';
                 return;
            }
            
            const startIndex = (currentRecommendationsPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedRecs = globalRecommendations.slice(startIndex, endIndex);

            paginatedRecs.forEach(r => {
                let icon = '<i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i>';
                let bgClass = 'bg-blue-50 border-blue-100';
                if(r.type === 'warning') {
                    icon = '<i class="fa-solid fa-triangle-exclamation text-amber-500 mt-0.5"></i>';
                    bgClass = 'bg-amber-50 border-amber-100';
                } else if(r.type === 'success') {
                    icon = '<i class="fa-solid fa-circle-check text-green-500 mt-0.5"></i>';
                    bgClass = 'bg-green-50 border-green-100';
                }
                
                recContainer.innerHTML += `
                    <div class="p-4 rounded-lg border ${bgClass} flex gap-3 text-sm text-gray-700">
                        ${icon}
                        <div>${r.message}</div>
                    </div>
                `;
            });
            
            renderPagination(globalRecommendations.length, currentRecommendationsPage, 'recommendations-pagination', (newPage) => {
                currentRecommendationsPage = newPage;
                renderRecommendations();
            });
        }

        // --- Reports Logic ---
        async function loadReportsData() {
            try {
                const data = await API.getGovtReports();
                reportsLoaded = true;

                // Create District Performance Chart
                const dists = data.district_performance || [];
                const districtLabels = dists.map(d => d.district);
                const districtHours = dists.map(d => d.hours);
                const districtAreas = dists.map(d => d.area);

                if(districtChart) districtChart.destroy();
                const ctxDist = document.getElementById('districtChart').getContext('2d');
                districtChart = new Chart(ctxDist, {
                    type: 'bar',
                    data: {
                        labels: districtLabels.length ? districtLabels : ['No Data'],
                        datasets: [
                            {
                                label: 'Usage Hours',
                                data: districtHours.length ? districtHours : [0],
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderRadius: 4
                            },
                            {
                                label: 'Area Covered (Acres)',
                                data: districtAreas.length ? districtAreas : [0],
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Create Idle Ratio Chart
                const idleMachines = dists.map(d => d.idle_machines);
                const totalMachines = dists.map(d => d.machines);
                
                if(idleChart) idleChart.destroy();
                const ctxIdle = document.getElementById('idleChart').getContext('2d');
                idleChart = new Chart(ctxIdle, {
                    type: 'line',
                    data: {
                        labels: districtLabels.length ? districtLabels : ['No Data'],
                        datasets: [
                            {
                                label: 'Total Inventory',
                                data: totalMachines.length ? totalMachines : [0],
                                borderColor: 'rgb(148, 163, 184)',
                                backgroundColor: 'rgba(148, 163, 184, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Idle Inventory',
                                data: idleMachines.length ? idleMachines : [0],
                                borderColor: 'rgb(245, 158, 11)',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Display Recommendations using Pagination
                globalRecommendations = data.recommendations || [];
                renderRecommendations();

            } catch(e) {
                console.error(e);
                document.getElementById('recommendations-container').innerHTML = '<div class="p-4 text-red-500 text-sm">Failed to load reports.</div>';
            }
        }

        // --- Handlers for New Govt Features ---
        async function handleRegisterCHC(e) {
            e.preventDefault();
            const data = {
                chc_name: document.getElementById('chc-name').value,
                state: document.getElementById('chc-state').value,
                district: document.getElementById('chc-district').value,
                location: document.getElementById('chc-location').value,
                pincode: document.getElementById('chc-pincode').value,
                contact_number: document.getElementById('chc-contact').value,
                email: document.getElementById('chc-email').value,
            };
            try {
                await API.registerCHC(data);
                UI.showToast('CHC registered successfully!', 'success');
                e.target.reset();
                if(viewId === 'all-chcs') loadGovtStats(); // reload if needed
            } catch (err) {
                UI.showToast(err.message || 'Failed to register CHC', 'error');
            }
        }

        async function handleRegisterAdmin(e) {
            e.preventDefault();
            const data = {
                username: document.getElementById('adm-username').value,
                password: document.getElementById('adm-password').value,
                email: document.getElementById('adm-email').value,
                first_name: document.getElementById('adm-first-name').value,
                last_name: document.getElementById('adm-last-name').value,
                phone_no: document.getElementById('adm-phone').value,
            };
            try {
                await API.registerCHCAdmin(data);
                UI.showToast('CHC Administrator Account Created!', 'success');
                e.target.reset();
            } catch (err) {
                UI.showToast(err.message || 'Failed to register admin', 'error');
            }
        }

        async function handleAssignAdmin(e) {
            e.preventDefault();
            const chcInputString = document.getElementById('assign-chc-input').value;
            const adminInputString = document.getElementById('assign-admin-input').value;
            
            // Extract the ID from the "ID - Name" format
            const chcIdMatch = chcInputString.match(/^(\d+)\s*-/);
            const adminIdMatch = adminInputString.match(/^(\d+)\s*-/);
            
            if (!chcIdMatch || !adminIdMatch) {
                UI.showToast('Please select a valid option from the dropdowns', 'error');
                return;
            }
            
            const chcId = chcIdMatch[1];
            const adminId = adminIdMatch[1];
            
            try {
                const res = await API.assignAdminToCHC(chcId, adminId);
                UI.showToast(res.message || 'Admin successfully assigned.', 'success');
                e.target.reset();
            } catch (err) {
                UI.showToast(err.message || 'Failed to assign admin', 'error');
            }
        }

        async function loadProfileForView() {
            try {
                const profile = await API.getProfile();
                document.getElementById('prof-username').value = profile.username || '';
                document.getElementById('prof-first-name').value = profile.first_name || '';
                document.getElementById('prof-last-name').value = profile.last_name || '';
                document.getElementById('prof-email').value = profile.email || '';
                document.getElementById('prof-phone').value = profile.phone_no || '';
            } catch(e) {
                console.error(e);
            }
        }

        async function populateAssignDropdowns() {
            try {
                // Populate CHCs
                const chcList = document.getElementById('chc-list');
                const chcs = await API.fetchAllPages('/chc/', true);
                chcList.innerHTML = '';
                chcs.forEach(c => {
                    chcList.innerHTML += `<option value="${c.id} - ${c.chc_name} (${c.district})"></option>`;
                });
                
                // Populate Admins
                const adminList = document.getElementById('admin-list');
                const admins = await API.getCHCAdmins();
                adminList.innerHTML = '';
                admins.forEach(a => {
                    const name = a.first_name || a.last_name ? `${a.first_name} ${a.last_name}` : a.username;
                    adminList.innerHTML += `<option value="${a.id} - ${name} (${a.email})"></option>`;
                });
            } catch(e) {
                console.error(e);
            }
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            const data = {
                first_name: document.getElementById('prof-first-name').value,
                last_name: document.getElementById('prof-last-name').value,
                email: document.getElementById('prof-email').value,
                phone_no: document.getElementById('prof-phone').value,
            };
            try {
                await API.updateProfile(data);
                UI.showToast('Profile updated!', 'success');
            } catch (err) {
                UI.showToast(err.message || 'Failed to update profile', 'error');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            const pwd = document.getElementById('prof-new-pwd').value;
            try {
                await API.changePassword(pwd);
                UI.showToast('Password changed!', 'success');
                e.target.reset();
            } catch (err) {
                UI.showToast(err.message || 'Failed to change password', 'error');
            }
        }
        
        // Initialize
        loadGovtStats();
    </script>
</body>
</html>