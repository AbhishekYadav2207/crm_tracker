<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Tracker - Advanced Machine Management</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- Navigation -->
    <nav class="glass-panel" style="position: sticky; top: 0; z-index: 40; padding: 1rem 2rem;">
        <div class="flex items-center justify-between" style="max-width: 1200px; margin: 0 auto;">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-tractor fa-2x" style="color: var(--primary);"></i>
                <span style="font-size: 1.5rem; font-weight: 800; color: var(--text-main);">CRM Tracker</span>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="UI.showModal('login-modal')">
                    <i class="fa-solid fa-right-to-bracket" style="margin-right: 0.5rem;"></i> Login
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="flex items-center justify-center p-8" style="min-height: 80vh; text-align: center; background: radial-gradient(circle at top right, #e0f2fe, #f8fafc);">
        <div style="max-width: 800px;">
            <h1 class="floating">Advanced Crop Residue Management</h1>
            <p style="font-size: 1.25rem; color: var(--text-muted); margin-bottom: 2rem;">
                Connect with Custom Hiring Centers (CHCs) to book machines efficiently. 
                Streamlining agriculture with technology.
            </p>
            <div class="flex justify-center gap-4">
                <button class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;" onclick="document.getElementById('search-section').scrollIntoView({behavior: 'smooth'})">
                    <i class="fa-solid fa-calendar-check" style="margin-right: 0.5rem;"></i> Book a Machine
                </button>
                <button class="btn btn-secondary" style="font-size: 1.1rem; padding: 1rem 2rem;" onclick="location.href='index.html#how-it-works'">
                    <i class="fa-solid fa-circle-info" style="margin-right: 0.5rem;"></i> How it Works
                </button>
            </div>
        </div>
    </header>

    <!-- Search Section -->
    <section id="search-section" class="p-8" style="background: white;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h2 class="text-center mb-8">Find a Center Near You</h2>
            <div class="glass-panel p-4" style="border-radius: var(--radius); display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <input type="text" placeholder="Search by Center Name, City, or District..." class="form-input" style="flex: 2; max-width: 500px;" id="search-query">
                <button class="btn btn-primary" onclick="searchCHCs()">Find Center</button>
            </div>
            
            <div id="chc-results" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                <!-- Results will be injected here -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="p-8" style="background: var(--text-main); color: white; text-align: center;">
        <p>&copy; 2026 CRM Tracker. All rights reserved.</p>
    </footer>

    <!-- Modals -->

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="UI.hideModal('login-modal')">&times;</button>
            <h2 class="text-center">Admin Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">Login</button>
            </form>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="UI.hideModal('booking-modal')">&times;</button>
            <h2 class="text-center">Book a Machine</h2>
            <form id="booking-form">
                <div class="form-group">
                    <label class="form-label">Select Machine</label>
                    <select name="machine" class="form-input" required id="machine-select">
                        <option value="">Loading machines...</option>
                    </select>
                </div>
                <div class="flex gap-4">
                    <div class="form-group w-full">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-input" required>
                    </div>
                    <div class="form-group w-full">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Title/Purpose</label>
                    <input type="text" name="purpose" class="form-input" placeholder="e.g., Sowing Wheat" required>
                </div>
                <div class="flex gap-4">
                    <div class="form-group w-full">
                         <label class="form-label">Farmer Name</label>
                         <input type="text" name="farmer_name" class="form-input" required>
                    </div>
                    <div class="form-group w-full">
                         <label class="form-label">Phone Number</label>
                         <input type="tel" name="farmer_contact" class="form-input" required maxlength="10">
                    </div>
                </div>
                <!-- Added Required Fields -->
                <div class="flex gap-4">
                    <div class="form-group w-full">
                        <label class="form-label">Email</label>
                        <input type="email" name="farmer_email" class="form-input" required>
                    </div>
                    <div class="form-group w-full">
                        <label class="form-label">Aadhar Number</label>
                        <input type="text" name="farmer_aadhar" class="form-input" required maxlength="12" placeholder="12-digit number">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Field Area (Acres)</label>
                    <input type="number" step="0.1" name="field_area" class="form-input" placeholder="Approx area">
                </div>

                <button type="submit" class="btn btn-primary w-full">Submit Request</button>
            </form>
        </div>
    </div>

    <!-- Machine List Modal -->
    <div id="machine-list-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" onclick="UI.hideModal('machine-list-modal')">&times;</button>
            <h2 class="text-center" id="chc-title">Machines Available</h2>
            <div id="machine-list-container" class="grid-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <!-- Machines injected here -->
            </div>
        </div>
    </div>
    <div id="toast-container" class="toast-container"></div>

    <script src="js/ui.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Init Logic
        document.addEventListener('DOMContentLoaded', async () => {
             // Machines are now loaded per CHC
        });

        // Machine View Logic
        async function viewMachines(chcId, chcName) {
            const container = document.getElementById('machine-list-container');
            const title = document.getElementById('chc-title');
            
            title.textContent = `Machines at ${chcName}`;
            container.innerHTML = '<p class="text-center w-full">Loading machines...</p>';
            
            UI.showModal('machine-list-modal');
            
            try {
                const machines = await API.getMachines(true, chcId);
                container.innerHTML = '';
                
                if (!machines || machines.length === 0) {
                    container.innerHTML = '<p class="text-center w-full text-muted">No machines available at this center.</p>';
                    return;
                }

                machines.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel p-4 flex flex-col justify-between';
                    card.style.borderLeft = m.status === 'Idle' ? '4px solid var(--success)' : '4px solid var(--accent)';
                    
                    card.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg">${m.machine_name}</h4>
                            <p class="text-sm text-muted">${m.machine_type}</p>
                            <span class="badge ${m.status === 'Idle' ? 'bg-success-light text-success' : 'bg-warning-light text-warning'}" 
                                  style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-top: 0.5rem;">
                                ${m.status}
                            </span>
                        </div>
        <button class="btn btn-primary w-full mt-4" 
                onclick='openBookingModal(${JSON.stringify(m)})'>
            Book Now
        </button>
        ${m.status !== 'Idle' ? '<p class="text-xs text-muted text-center mt-2">Available for future booking</p>' : ''}
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-center w-full text-danger">Failed to load machines.</p>';
            }
        }

        function openBookingModal(machine) {
            UI.hideModal('machine-list-modal');
            UI.showModal('booking-modal');
            
            // Pre-fill machine select
            const select = document.getElementById('machine-select');
            select.innerHTML = ''; // Clear existing
            const opt = document.createElement('option');
            opt.value = machine.id;
            opt.textContent = `${machine.machine_name} (${machine.machine_type})`;
            opt.selected = true;
            select.appendChild(opt);
            
            // Maybe add a hidden title or update modal title
            // document.querySelector('#booking-modal h2').textContent = `Book ${machine.machine_name}`;
        }
        // Search Handlers
        async function searchCHCs() {
            const query = document.getElementById('search-query').value;
            const resultsDiv = document.getElementById('chc-results');
            
            resultsDiv.innerHTML = '<p class="text-center w-full">Searching...</p>';
            
            try {
                // Pass as 'search' param for text search on name/location
                const chcs = await API.searchCHCs({ search: query });
                resultsDiv.innerHTML = '';
                
                if (chcs.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-center w-full">No centers found.</p>';
                    return;
                }

                chcs.forEach(chc => {
                    const card = document.createElement('div');
                    card.className = 'glass-panel p-4';
                    card.innerHTML = `
                        <h3 class="text-primary">${chc.chc_name}</h3>
                        <p><i class="fa-solid fa-location-dot"></i> ${chc.location}, ${chc.district}</p>
                        <p class="text-muted text-sm mt-2">Manager: ${chc.admin_name}</p>
                        <div class="flex gap-2 mt-4">
                            <button class="btn btn-primary w-full" onclick="viewMachines(${chc.id}, '${chc.chc_name}')">View Machines</button>
                            <button class="btn btn-secondary w-full" onclick="UI.showToast('Call ${chc.phone_no} for details')">Contact</button>
                        </div>
                    `;
                    resultsDiv.appendChild(card);
                });

            } catch (err) {
                 resultsDiv.innerHTML = '<p class="text-center w-full text-danger">Error searching.</p>';
            }
        }

        // Form Handlers
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const user = await API.login(formData.get('username'), formData.get('password'));
                if (user) {
                    UI.showToast('Login Successful!', 'success');
                    setTimeout(() => {
                        if (user.role === 'GOVT_ADMIN') window.location.href = 'govt_dashboard.html';
                        else if (user.role === 'CHC_ADMIN') window.location.href = 'chc_dashboard.html';
                        else window.location.href = 'index.html';
                    }, 1000);
                }
            } catch (err) {
                UI.showToast(err.message || 'Login failed', 'error');
            }
        });

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                await API.createBooking(data);
                UI.showToast('Booking submitted successfully!', 'success');
                UI.hideModal('booking-modal');
                e.target.reset();
            } catch (err) {
                UI.showToast(err.message || 'Booking failed', 'error');
            }
        });
    </script>
</body>
</html>
